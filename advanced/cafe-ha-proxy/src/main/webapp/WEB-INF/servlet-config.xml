<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xmlns:int="http://www.springframework.org/schema/integration"
	xmlns:int-amqp="http://www.springframework.org/schema/integration/amqp"
	xmlns:rabbit="http://www.springframework.org/schema/rabbit"
	xmlns:int-file="http://www.springframework.org/schema/integration/file"
	xmlns:int-http="http://www.springframework.org/schema/integration/http"
	xmlns:task="http://www.springframework.org/schema/task"
	xsi:schemaLocation="http://www.springframework.org/schema/integration/http http://www.springframework.org/schema/integration/http/spring-integration-http.xsd
		http://www.springframework.org/schema/integration/amqp http://www.springframework.org/schema/integration/amqp/spring-integration-amqp.xsd
		http://www.springframework.org/schema/integration http://www.springframework.org/schema/integration/spring-integration.xsd
		http://www.springframework.org/schema/integration/file http://www.springframework.org/schema/integration/file/spring-integration-file.xsd
		http://www.springframework.org/schema/task http://www.springframework.org/schema/task/spring-task-3.1.xsd
		http://www.springframework.org/schema/rabbit http://www.springframework.org/schema/rabbit/spring-rabbit.xsd
		http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd">

	<int-http:inbound-gateway id="httpInboundGateway" 
									  request-channel="jsonNewOrders" 
									  name="/placeOrder.htm" 
									  supported-methods="GET, POST" />
	
	<int:channel id="jsonNewOrders"/>

	<int-amqp:outbound-gateway 
		id="cafeOperations" 
		request-channel="jsonNewOrders" 
		exchange-name="cafe-orders"
		routing-key="order.new"
		amqp-template="amqpTemplate" />

	<!-- rabbit exchanges, queues, and bindings used by this app -->
	<rabbit:topic-exchange name="cafe-orders" auto-delete="false" durable="true">
		<rabbit:bindings>
			<rabbit:binding queue="new-orders" pattern="order.*"/>
			<rabbit:binding queue="all-orders" pattern="order.*"/>
		</rabbit:bindings>
	</rabbit:topic-exchange>
	
	<rabbit:queue name="new-orders" auto-delete="false" durable="true" queue-arguments="haArgs"/>	
	<rabbit:queue name="all-orders" auto-delete="false" durable="true" queue-arguments="haArgs"/>	

	<rabbit:fanout-exchange name="cafe-deliveries" auto-delete="false" durable="true">
		<rabbit:bindings>
			<rabbit:binding queue="new-deliveries" />
		</rabbit:bindings>
	</rabbit:fanout-exchange>
	
	<rabbit:queue name="new-deliveries" auto-delete="false" durable="true" queue-arguments="haArgs" />	

    <!-- Request that queues, exchanges and bindings be automatically declared 
        on the broker: -->
    <rabbit:admin connection-factory="rabbitConnectionFactory" />

    <!-- connect to the local broker using the default user name and password -->
    <rabbit:connection-factory 
    	id="rabbitConnectionFactory" 
    	addresses="172.16.227.150,172.16.227.151"/>

    <!-- Set up the AmqpTemplate/RabbitTemplate: -->
    <rabbit:template id="amqpTemplate"
        connection-factory="rabbitConnectionFactory" 
		reply-queue="new-deliveries"
        reply-timeout="60000" />

    <rabbit:queue-arguments id="haArgs">
   		<entry key="x-ha-policy" value="all" />
	</rabbit:queue-arguments>

    <rabbit:listener-container id="deliveryReplyContainer" connection-factory="rabbitConnectionFactory" task-executor="delivery-reply-exec">
        <rabbit:listener ref="amqpTemplate" queues="new-deliveries"/>
    </rabbit:listener-container>

    <task:executor id="delivery-reply-exec" />

</beans>
